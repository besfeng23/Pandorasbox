# Data Model — Firestore + Storage

## Purpose
Document the entities (collections/documents), indexes, and security scoping used by Pandora’s Box — derived from `firestore.rules`, `firestore.indexes.json`, and collection usage in `src/lib/*`, `src/ai/*`, `src/app/actions/*`.

## Key principles
- **Primary scoping key**: `userId` on root-level documents (`history`, `threads`, `memories`, `artifacts`, etc.).
- **Defense-in-depth**: Client SDK reads/writes are gated by `firestore.rules`; server-side code uses Firebase Admin (`src/lib/firebase-admin.ts`) and can bypass rules.
- **Embeddings**: stored directly on documents (e.g. `history.embedding`, `memories.embedding`) and indexed via Firestore vector indexes.

## Collections (inferred)
This list is repo-derived via `.collection('...')` usage and rules/index definitions.

### `threads`
- **Purpose**: Conversation threads.
- **Typical fields** (see `src/lib/types.ts`, `src/app/actions/chat.ts`):\n  - `id` (string)\n  - `userId` (string)\n  - `title` (string)\n  - `createdAt` (timestamp)\n  - `summary?` (string)\n  - `pinned?`, `archived?`, `updatedAt?`\n- **Security**: `firestore.rules` restricts read/write to `resource.data.userId == request.auth.uid`.\n- **Index**: `firestore.indexes.json` includes composite index for `userId` + `createdAt`.\n\n**Sample**:\n```json\n{\n  \"id\": \"thread_abc\",\n  \"userId\": \"uid_123\",\n  \"title\": \"New Chat\",\n  \"createdAt\": \"<serverTimestamp>\",\n  \"summary\": \"...\"\n}\n```\n\n### `history`\n- **Purpose**: Messages (user/assistant/system) for threads and knowledge chunks.\n- **Typical fields** (see `src/lib/types.ts`, `src/app/actions/chat.ts`, `src/ai/flows/run-chat-lane.ts`):\n  - `id`, `userId`, `threadId`\n  - `role`: `user|assistant|system`\n  - `content`\n  - `createdAt`\n  - `embedding?` (number[1536])\n  - `status?`: `processing|complete|error`\n  - `progress_log?` (string[])\n  - `type?`: `briefing|standard|knowledge_chunk`\n  - `imageUrl?`, `audioUrl?`, `source?`\n- **Vector search**: `searchHistory` in `src/lib/vector.ts` performs `findNearest` over `embedding`.\n- **Security**: rule stanza for `/history/{messageId}` requires auth and ownership.\n- **Indexes**: vector index for `embedding`, plus composites used by UI subscriptions (`userId + threadId + createdAt`).\n\n### `memories`\n- **Purpose**: Long-term memory items used for retrieval.\n- **Creation path**: `saveMemory` / `saveMemoriesBatch` in `src/lib/memory-utils.ts`.\n- **Typical fields**:\n  - `id`, `userId`\n  - `content`\n  - `embedding` (number[1536])\n  - `createdAt`\n  - `source?` (`conversation`, `chatgpt`, `mcp`, `knowledge_upload`, `deep_research`, etc.)\n  - `type?` (`normal|insight|question_to_ask`)\n  - `importance?` (Phase 3 weighting; also stored in `context_store`)\n  - optional metadata fields merged into doc\n- **Vector search**: `searchMemories` in `src/lib/vector.ts`.\n- **Security**: rule stanza for `/memories/{memoryId}` restricts to owner.\n- **Indexes**: vector index for `embedding`, composite for `userId + createdAt`.\n\n### `artifacts`\n- **Purpose**: Extracted artifacts from responses or created via MCP.\n- **Creation path**: `extractAndSaveArtifact` in `src/ai/flows/run-answer-lane.ts`, MCP `generate_artifact` in `src/mcp/tools/generate-artifact.ts`.\n- **Fields** (see `src/lib/types.ts`): `id`, `userId`, `title`, `type`, `content`, `version`, `createdAt`.\n- **Security**: rule stanza for `/artifacts/{artifactId}` restricts to owner.\n\n### `settings`\n- **Purpose**: Per-user settings (model selection, reply style, prompt override, personal API key).\n- **Access**:\n  - Client hook: `src/hooks/use-settings.ts`\n  - Server action: `src/app/actions/user.ts` (`updateSettings`, `generateUserApiKey`)\n- **Security**: `/settings/{userId}` restricted to owner.\n\n### `users/{userId}/state/*` (subcollection)\n- **Purpose**: Per-user state docs like context note and suggestions.\n- **Paths**:\n  - Context: `users/{userId}/state/context` (written in `src/ai/flows/run-memory-lane.ts`, read in daily briefing cron)\n  - Suggestions: `users/{userId}/state/suggestions` (written in `src/ai/flows/run-chat-lane.ts`)\n- **Security**: `match /users/{userId}/{document=**}` in `firestore.rules`.\n\n### Knowledge graph\n- **Nodes**: `system_knowledge_graph` (see constants in `src/lib/knowledge-graph.ts`)\n- **Edges**: `knowledge_edges`\n- **Security**: both are owner-scoped by `userId`.\n\n### Phase system + telemetry\n- `system_phases`: seeded by `scripts/seed-phases.ts`, read by UI `src/app/(pandora-ui)/components/PhaseDashboard.tsx` and `PhaseIndicator.tsx`.\n- `system_federation`, `system_selfheal`, `system_governance`: telemetry seeded by `scripts/seed-telemetry.ts`.\n\n### Phase 5 external cache\n- `external_knowledge`: shared cache (readable by any authenticated user, write denied client-side; server writes via Admin).\n- **Code**: `src/lib/external-cache.ts`.\n\n### Phase 6 feedback + performance + learning\n- `feedback`: written by `src/lib/feedback-manager.ts` and `/api/feedback`.\n- `performance_metrics`: referenced by rules and indexes; performance tracking logs also go to stdout for Cloud Logging (`src/lib/performance-tracker.ts`).\n- `meta_learning_state`: per-user learning state (`src/lib/meta-learning.ts`).\n\n### Other collections\n- `rateLimits`: rate limit state (`src/lib/rate-limit.ts`).\n- `learning_queue`: deep research queue (`src/ai/flows/run-chat-lane.ts`, `src/ai/agents/deep-research.ts`).\n- `graph_analytics`: temporal snapshots (`src/lib/graph-analytics.ts`).\n\n## Indexes (what exists)\nSource of truth: `firestore.indexes.json`.\n- Vector indexes:\n  - `history.embedding` (dimension 1536)\n  - `memories.embedding` (dimension 1536)\n  - `external_knowledge.queryEmbedding` (present in indexes file)\n  - `system_knowledge_graph.embedding` (present in indexes file)\n- Composite indexes exist for common UI queries (threads by createdAt, history by threadId+userId+createdAt, etc.).\n\n## Security scoping (rules summary)\nSource of truth: `firestore.rules`.\n- Owner-scoped collections require `request.auth.uid == resource.data.userId`.\n- Shared caches/logs are read-only to clients (write false) and rely on server-side Admin writes.\n\n## Where in code\n- **Types**: `src/lib/types.ts`\n- **Memory persistence**: `src/lib/memory-utils.ts`\n- **Vector search**: `src/lib/vector.ts`\n- **Knowledge graph**: `src/lib/knowledge-graph.ts`\n- **Rules**: `firestore.rules`\n- **Indexes**: `firestore.indexes.json`\n- **Storage rules**: `storage.rules`


