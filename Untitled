## Kairos Stabilization Publish — production-grade checklist (cross-platform)

This repo now has a **deterministic, CI-safe Kairos publish pipeline** that will not fail due to missing env defaults, missing/empty contract files, or shell differences (PowerShell vs bash).

---

## ✅ 1) Verify the contract is in-repo

Expected path:

- `contracts/kairos/stabilization_sprint_plan.json`

If it’s missing or empty, publishing will **fail fast** with a non-zero exit code.

---

## ✅ 2) Run a dry-run first (recommended)

Dry-run performs **all validations** and prints a diagnostics block, but **does not send** any network requests:

```bash
corepack enable
pnpm install
pnpm run kairos:publish:dry-run
```

Diagnostics include:
- Resolved `KAIROS_BASE_URL`
- Contract file path (absolute + relative)
- Contract file size + SHA-256 hash
- Payload key count + counts for bugClusters/fixSequence/gatingRules

---

## ✅ 3) Publish for real (sends request)

```bash
pnpm run kairos:publish
```

Notes:
- Uses `KAIROS_BASE_URL` if set, otherwise defaults to `https://kairostrack.base44.app`
- Retries network errors **3 times** with exponential backoff
- Does **not** retry 4xx errors (except **429**)
- Exits with **0** on success, **1** on failure (CI-safe)

---

## ✅ 4) (Optional) Override base URL / contract path

```bash
pnpm run kairos:publish -- --base-url https://kairostrack.base44.app --contract contracts/kairos/stabilization_sprint_plan.json
```

---

## ✅ 5) Run the unit tests for publish determinism

We intentionally isolate these from the broader test suite (which may have unrelated failures):

```bash
pnpm run test:kairos
```

---

## ✅ 6) Backwards compatibility

The legacy command still works, but now delegates to the hardened publish CLI:

```bash
pnpm run kairos:register:stabilization
```

---

## ✅ 7) Auto-commit workflow

After any file changes, this repo is configured to auto-stage/commit/push and emit Kairos events:

```bash
npm run auto-commit
```

This is cross-platform and will run Kairos scripts using the detected package manager (`pnpm`/`yarn`/`npm`) to avoid env/shell issues.
