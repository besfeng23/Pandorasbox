rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Users collection
    match /users/{userId}/{document=**} {
      allow read, write: if isOwner(userId);
    }
    
    // Settings
    match /settings/{userId} {
      allow read, write: if isOwner(userId);
    }

    // History collection - users can only access their own messages
    match /history/{messageId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Threads collection - users can only access their own threads
    match /threads/{threadId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Artifacts collection - users can only access their own artifacts
    match /artifacts/{artifactId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Memories collection (root level) - users can only access their own memories
    match /memories/{memoryId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Analytics collection - users can only access their own analytics
    match /analytics/{analyticsId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Knowledge graph nodes - users can only access their own graph nodes
    match /system_knowledge_graph/{nodeId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Knowledge graph edges - users can only access their own graph edges
    match /knowledge_edges/{edgeId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Phase 5: Graph analytics - users can only access their own analytics
    match /graph_analytics/{snapshotId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Phase 3: Context store - users can only access their own context sessions
    match /context_store/{sessionId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // RateLimits collection - users can only access their own rate limit data
    match /rateLimits/{rateLimitId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Phase 5: External Knowledge cache - server-side only (no userId, public cache)
    // This is a shared cache for external search results to reduce API calls
    match /external_knowledge/{cacheId} {
      // Allow server-side writes (from Firebase Admin SDK)
      // Allow authenticated reads for any user (shared cache)
      allow read: if request.auth != null;
      allow write: if false; // Only server-side writes via Admin SDK
    }

    // Phase 6: Feedback collection - users can only access their own feedback
    match /feedback/{feedbackId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Phase 6: Performance metrics - users can only access their own metrics
    match /performance_metrics/{metricId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Phase 6: Meta-learning state - users can only access their own learning state
    match /meta_learning_state/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false; // Never allow deletion - preserve learning state
    }

    // System logs - server-side only (no userId, for system monitoring)
    match /system_logs/{logId} {
      allow read: if request.auth != null; // Authenticated users can read logs
      allow write: if false; // Only server-side writes via Admin SDK
    }
  }
}
